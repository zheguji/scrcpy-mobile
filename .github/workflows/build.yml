name: "Build"

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Check Xcode version
        run: /usr/bin/xcodebuild -version

      # 如果仓库里确实需要 pnpm 再保留；否则可以删除
      - uses: pnpm/action-setup@v4
        with:
          version: 9.9.0

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # ← 非 Go 项目，删除 setup-go，避免 go.sum 缓存报错
      # - uses: actions/setup-go@v5
      #   with:
      #     go-version: '1.22.5'
      #     cache: false

      - name: Install dependencies (safe)
        # 失败就 fail，便于排查；不再吞错
        run: |
          brew update
          # 只在缺失时安装，避免与 pinned tap 冲突
          for pkg in cmake ninja nasm yasm pkg-config autoconf automake libtool; do
            if ! brew list --versions "$pkg" >/dev/null 2>&1; then
              brew install "$pkg"
            else
              echo "✅ $pkg already installed: $(brew list --versions $pkg)"
            fi
          done
          # 如需要 OpenSSL，确认/安装 openssl@3（不要卸载系统自带 openssl）
          if ! brew list --versions openssl@3 >/dev/null 2>&1; then
            brew install openssl@3
          fi
          # 安装特定版本的 protobuf（28.3）并确保 protoc 在 PATH 中
          if [ -f "./porting/protobuf.rb" ]; then
            echo "Unlink any existing protobuf to avoid link conflicts"
            brew unlink protobuf || true
            echo "Install protobuf from local formula (porting/protobuf.rb)"
            brew install ./porting/protobuf.rb
            echo "Force-link protobuf so protoc is available on PATH"
            brew link --overwrite protobuf || true
            # 将 protobuf 的 bin 加入 PATH 供后续 step 使用
            PROTO_PREFIX=$(brew --prefix protobuf 2>/dev/null || brew --prefix protobuf@28.3 2>/dev/null || true)
            if [ -n "$PROTO_PREFIX" ] && [ -d "$PROTO_PREFIX/bin" ]; then
              echo "$PROTO_PREFIX/bin" >> "$GITHUB_PATH"
            fi
          fi
          cmake --version

      - name: Verify protoc
        run: |
          which protoc || true
          protoc --version || { echo "protoc is missing; protobuf install/link likely failed" >&2; exit 1; }

      - name: Build
        run: make

      - name: Upload to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: output
          path: output/
